:set -XDataKinds
:set -XScopedTypeVariables

:m +Data.Int 
import Criterion.Main
import Language.Haskell.TH.Quote
import System.FilePath
import Control.Monad.R.Unsafe

:{
let hFib :: Foreign.R.Internal.SEXP Foreign.R.Internal.Int -> H.Prelude.R s (Foreign.R.Internal.SEXP Foreign.R.Internal.Int)
    hFib n@(H.Prelude.fromSEXP -> (0 :: Int32)) = H.protectRegion $ fmap (Foreign.R.unSEXP . Foreign.R.cast Foreign.R.Int) [r| as.integer(0) |]
    hFib n@(H.Prelude.fromSEXP -> (1 :: Int32)) = H.protectRegion $ fmap (Foreign.R.unSEXP . Foreign.R.cast Foreign.R.Int) [r| as.integer(1) |]
    hFib n                              = H.protectRegion $ do
        fmap (Foreign.R.unSEXP . Foreign.R.cast Foreign.R.Int) [r| as.integer(hFib_hs(as.integer(n_hs - 1)) + hFib_hs(as.integer(n_hs - 2))) |]
:}

unsafeRToIO $ $(quoteExp (quoteFile r) ("tests" </> "R" </> "fib.R"))

:{
defaultMain [
    bgroup "fib"
      [ bench "runtime-qq" $
          whnfIO $ unsafeRToIO [r| fib(10) |]
      , bench "runtime-qq-hybrid" $
          whnfIO $ unsafeRToIO $ hFib =<< unsafeIOToR (Language.R.Literal.Unsafe.unsafeMkSEXP (10 :: Int32))
      ]
   ]
:}
