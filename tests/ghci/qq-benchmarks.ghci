:set -XDataKinds
:set -XScopedTypeVariables

:m +Data.Int
import Criterion.Main
import Language.Haskell.TH.Quote
 
import System.FilePath
 

:{
let hFib :: SEXP Foreign.R.Internal.Int -> H.Prelude.R (SEXP Foreign.R.Internal.Int)
    hFib n@(H.Prelude.fromSEXP -> (0 :: Int32)) = fmap (flip Foreign.R.Internal.asTypeOf n) [r| as.integer(0) |]
    hFib n@(H.Prelude.fromSEXP -> (1 :: Int32)) = fmap (flip Foreign.R.Internal.asTypeOf n) [r| as.integer(1) |]
    hFib n                              = H.Prelude.withProtected (return n) $ const $
        fmap (flip Foreign.R.Internal.asTypeOf n) [r| as.integer(hFib_hs(as.integer(n_hs - 1)) + hFib_hs(as.integer(n_hs - 2))) |]
:}

$(quoteExp (quoteFile r) ("tests" </> "R" </> "fib.R"))

:{
defaultMain [
    bgroup "fib"
      [ bench "runtime-qq" $
          whnfIO $ [r| fib(10) |]
      , bench "runtime-qq-hybrid" $
          whnfIO $ H.Prelude.unsafeRToIO $ hFib $ H.mkSEXP (10 :: Int32)
      ]
   ]
:}
