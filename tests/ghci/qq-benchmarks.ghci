:set -XDataKinds
:set -XScopedTypeVariables

import Foreign.R as R
import Criterion.Main
import Data.Int
import Language.Haskell.TH.Quote

import System.FilePath

:{
let hFib :: Foreign.R.SEXP (Foreign.R.Vector Int32) -> R (Foreign.R.SEXP (Foreign.R.Vector Int32))
    hFib (fromSEXP -> (0 :: Int32)) = [r| 0 |]
    hFib (fromSEXP -> (1 :: Int32)) = [r| 1 |]
    hFib n = [r| hFib_hs(n_hs - 1) + hFib_hs(n_hs - 2) |]
:}

$(quoteExp (quoteFile r) ("tests" </> "R" </> "fib.R"))
:{
defaultMain [
    bgroup "fib"
      [ bench "runtime-qq" $
          whnfIO $ [r| fib(18) |]
      , bench "runtime-qq-hybrid" $
          whnfIO $ runR $ hFib $ mkSEXP (18 :: Int32)
      ]
   ]
:}
